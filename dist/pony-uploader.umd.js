!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).PonyUploader={})}(this,function(e){"use strict";var t=function(){};t.browserCanLoadImages=function(){return void 0!==typeof atob&&void 0!==typeof Uint8Array&&void 0!==typeof Blob&&void 0!==typeof ArrayBuffer},t.fileIsJpeg=function(e){return"image/jpg"===e.type||"image/jpeg"===e.type},t.arrayBufferFromImage=function(e){return this.dataUriToArrayBuffer(e.src)},t.dataViewFromImage=function(e){var t=this.dataUriToArrayBuffer(e.src);return new DataView(t)},t.dataUriToArrayBuffer=function(e){if("string"!=typeof e)throw new Error("Invalid argument: dataURI must be a string");for(var t=atob(e.split(",")[1]),a=t.length,i=new ArrayBuffer(a),r=new Uint8Array(i),n=0;n<a;n++)r[n]=t.charCodeAt(n);return i},t.dataUriToBlob=function(e,t){if("string"!=typeof e)throw new Error("Invalid argument: dataURI must be a string");for(var a=atob(e.split(",")[1]),i=[],r=0;r<a.length;r++)i.push(a.charCodeAt(r));return new Blob([new Uint8Array(i)],{type:t})},t.dataUrlToImage=function(e){var t=new Image;return t.src=e,t},t.imageToBlob=function(e,t){return this.dataUriToBlob(e.src,t)};var a={274:"orientation",306:"dateTaken",271:"cameraMake",272:"cameraModel"},i=function(e){this.image=e,this.dataView=t.dataViewFromImage(e),this.isLittleEndian=!0};i.prototype.isJpeg=function(){return 65496===this.dataView.getUint16(0)},i.prototype.read=function(){if(!this.isJpeg())return null;var e=this._findStartOfExifData();return e?this._readEXIFData(e):null},i.prototype._findStartOfExifData=function(){for(var e=2;e<this.dataView.byteLength;)return 65505!==this.dataView.getUint16(e)&&(e+=2+this.dataView.getUint16(e+2)),e+4;return null},i.prototype._chooseEndianessFromTiffHeader=function(e){18761===this.dataView.getUint16(e)?this.isLittleEndian=!0:19789===this.dataView.getUint16(e)?this.isLittleEndian=!1:this.isLittleEndian=void 0},i.prototype._isValidExifStructure=function(e){return"Exif"===this._getStringFromBuffer(this.dataView,e,4)&&42===this.dataView.getUint16(e+8,this.isLittleEndian)},i.prototype._readEXIFData=function(e){var t=e+6;if(this._chooseEndianessFromTiffHeader(t),!this._isValidExifStructure(e))return null;var a=this.dataView.getUint32(t+4,this.isLittleEndian);return a<8?null:this._readTags(t,t+a)},i.prototype._readTags=function(e,t){for(var i=this.dataView.getUint16(t,this.isLittleEndian),r={},n=0;n<i;n++){var o=t+12*n+2,s=a[this.dataView.getUint16(o,this.isLittleEndian)];s&&(r[s]=this._readTagValue(o,e))}return r},i.prototype._readTagValue=function(e,t){var a=this.dataView.getUint16(e+2,this.isLittleEndian),i=this.dataView.getUint32(e+4,this.isLittleEndian),r=e+8,n=t+this.dataView.getUint32(r,this.isLittleEndian);switch(a){case 2:var o=i>4?n:r;return this._getStringFromBuffer(this.dataView,o,i-1);case 3:if(1===i)return this.dataView.getUint16(r);for(var s=i>2?n:r,d=[],l=0;l<i;l++){var u=2*l;d[l]=this.dataView.getUint16(s+u)}return d}},i.prototype._getStringFromBuffer=function(e,t,a){for(var i="",r=t;r<t+a;r++)i+=String.fromCharCode(e.getUint8(r,this.isLittleEndian));return i};var r=function(e){this.file=e,this.reader=null,this.image=null,this.exif=null};r.prototype.load=async function(){var e={name:this.file.name,size:this.file.size,file:this.file};if(!t.browserCanLoadImages())return e;var a=await this._loadLocalFile(this.file);if(!a)return e;if(this.image=await this._createImageFromLocalFile(a,this.file),!this.image)return e;e.image=this.image,e.width=this.image.width,e.height=this.image.height;try{e.exif=this.exif=new i(this.image).read()}catch(e){console.error("Error reading exif: "+e)}return e.metadata=this._buildMetadata(),e},r.prototype._buildMetadata=function(e){var t={};return t.filename=this.file.name,t.width=this.image.width,t.height=this.image.height,this.exif&&(t["exif-date-taken"]=this.exif.dateTaken,t["exif-camera-make"]=this.exif.cameraMake,t["exif-camera-model"]=this.exif.cameraModel),t},r.prototype._loadLocalFile=function(e){if(!e.type.match("image.*"))throw new Error("The input file is not a supported image: "+e.type);return new Promise(function(t,a){var i=new FileReader;i.onload=function(){t(this.result)},i.onabort=function(){a(new Error("The file read was aborted: "+e.name))},i.onerror=function(t){a(t||new Error("An error occured while reading the file: "+e.name))},i.readAsDataURL(e)})},r.prototype._createImageFromLocalFile=function(e,t){return new Promise(function(a,i){var r=new Image;r.onload=function(){a(r)},r.onabort=function(){i(new Error("Image load was aborted: "+t.name))},r.onerror=function(e){i(e||new Error("An error occured while loading image: "+t.name))},r.src=e})};var n=function(){};n.resizeLoadedImage=async function(e,a){return t.browserCanLoadImages()?this.scaleAndRotateImage(e,a):null},n.scaleAndRotateImage=function(e,a){void 0===a&&(a={});var i=e.exif?e.exif.Orientation:1,r=this.determineScaledDimensions(e,a),n=a.width||r.width,o=a.height||r.height,s=a.backgroundFillStyle||"#FFF",d=this.buildOrientedCanvas(n,o,i),l=d.getContext("2d"),u=Math.floor((n-r.width)/2),p=Math.floor((o-r.height)/2);l.fillStyle=s,l.fillRect(0,0,n,o),l.drawImage(e.image,0,0,e.image.width,e.image.height,u,p,r.width,r.height);var h=d.toDataURL("image/jpeg",a.jpgQuality||.8);document.body.removeChild(d);var c=t.dataUrlToImage(h),f=Object.assign({},e.metadata);return f["original-width"]=e.width,f["original-height"]=e.height,f.width=r.width,f.height=r.height,{image:c,width:c.width,height:c.height,file:e.file,exif:e.exif,metadata:f}},n.determineScaledDimensions=function(e,t){var a=e.width,i=e.height,r=a,n=i;if(t&&(r=t.width,n=t.height),e.width>r||e.height>n){var o=e.width/r,s=e.height/n;o<s?(a=e.width/s,i=n):(a=r,i=e.height/o)}return{width:Math.floor(a),height:Math.floor(i)}},n.buildOrientedCanvas=function(e,t,a){void 0===a&&(a=1),a>8&&(a=1);var i=document.createElement("canvas");i.id="hiddenCanvas",i.width=e,i.height=t,i.style.visibility="hidden",a>4&&(i.width=t,i.height=e);var r=i.getContext("2d");switch(a){case 2:r.translate(e,0),r.scale(-1,1);break;case 3:r.translate(e,t),r.rotate(Math.PI);break;case 4:r.translate(0,t),r.scale(1,-1);break;case 5:r.rotate(.5*Math.PI),r.scale(1,-1);break;case 6:r.rotate(.5*Math.PI),r.translate(0,-t);break;case 7:r.rotate(.5*Math.PI),r.translate(e,-t),r.scale(-1,1);break;case 8:r.rotate(-.5*Math.PI),r.translate(-e,0)}return document.body.appendChild(i),i};var o=function(){};o.performJsonRequest=async function(e){e.headers=e.headers||{},e.headers.Accept="application/json";var t=await this.performRequest(e);try{t.json=JSON.parse(t.text)}catch(e){}return t},o.performRequest=function(e){if(!e.method)throw new Error("method is required");if(!e.url)throw new Error("url is required");var t=this._createCORSRequest(e.method,e.url);if(!t)throw new Error("File uploads are not supported by this browser.");for(var a in e.headers)t.setRequestHeader(a,e.headers[a]);return new Promise(function(a,i){t.onload=function(){a({status:t.status,text:t.responseText,xhr:t})},t.onerror=function(e){var a=new Error("A file upload error occurred: "+t.status);a.cause=e,i(a)},t.upload&&e.onprogress&&(t.upload.onprogress=function(t){var a=Math.round(t.loaded/t.total*100);e.onprogress(a)});try{e.json?(t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(e.json))):e.body?t.send(e.body):t.send()}catch(e){i(e)}})},o._createCORSRequest=function(e,t){var a=new XMLHttpRequest;return null!==a.withCredentials?a.open(e,t,!0):"undefined"!=typeof XDomainRequest&&(a=new XDomainRequest).open(e,t),a};var s=function(e,t){this.imageIndexApiUrl=e,this.imageCollection=t};s.prototype.add=async function(e){var t=e;t.collection=this.imageCollection;var a=await o.performJsonRequest({method:"POST",url:this.imageIndexApiUrl,json:t});if(a.json)return a.json;throw new Error("Error adding image status: "+a.text)},s.prototype.persist=async function(e,t){console.info("fileInfo => "+JSON.stringify(e));var a=await o.performJsonRequest({method:"PUT",url:this.imageIndexApiUrl+"/"+t,json:e});if(a.json)return a.json;throw new Error("Error adding image status: "+a.text)};var d=function(e){this.signUploadApiUrl=e};d.prototype.signUpload=async function(e){var t=await o.performJsonRequest({method:"PUT",url:this.signUploadApiUrl,json:e});if(t.json&&t.json.service&&t.json.uploadUrl)return t.json;throw new Error("Error signing upload: invalid data returned: "+t.text)};var l=function(){};l.prototype.upload=async function(e,t,a){var i={method:"PUT",url:e.uploadUrl,headers:{"Content-Type":e.filetype,"x-amz-acl":"public-read"},body:t,onprogress:a};e.metadata&&(i.headers=Object.assign({},i.headers,e.metadata));var r=await o.performRequest(i);if(200!==r.status)throw new Error("Error uploading image: "+r.status+", "+r.text);return{bucket:e.bucket,key:e.key,publicUrl:e.publicUrl}};var u=function(){};u.prototype.upload=async function(e,t,a){var i={method:"PUT",url:e.uploadUrl,headers:{"Content-Type":e.filetype},body:t,onprogress:a};e.metadata&&(i.headers=Object.assign({},i.headers,e.metadata));var r=await o.performRequest(i);if(200!==r.status)throw new Error("Error uploading image: "+r.status+", "+r.text);return{bucket:e.bucket,key:e.key,publicUrl:e.publicUrl}};var p={name:"pony-uploader",components:{},props:{value:{type:Object,required:!1},baseUrl:{type:String,required:!0},signatureUrl:{type:String,required:!0},trackImageStatus:{type:Boolean,required:!1,default:!1},imageStatusCollection:{type:String,required:!1,default:"images"},imageIndexUrl:{type:String,required:!1,default:"/index"},width:{type:Number,required:!1,default:200},height:{type:Number,required:!1,default:200},imageWidth:{type:Number,required:!1,default:200},imageHeight:{type:Number,required:!1,default:200},jpgQuality:{type:Number,required:!1,default:1},imageBackgroundColor:{type:String,required:!1,default:"#9ff"}},data:function(){return{state:"empty",initialState:"empty",dropZoneClass:"dropZoneDefault",acceptDrop:!1,image:null,uploadPercent:0}},methods:{_selectedFile:function(e){var t=event.target.files[0];t&&this._loadFile(t)},_dragEnter:function(e){this.acceptDrop=!0},_dragLeave:function(){this.acceptDrop=!1},_dragOver:function(){},_drop:async function(e){if(this.acceptDrop=!1,e&&e.dataTransfer&&e.dataTransfer.files){var t=e.dataTransfer.files[0];t&&this._loadFile(t)}},_loadFile:async function(e){if(this.isAllowedFileType(e)){var t=await new r(e).load(),a={width:this.imageWidth,height:this.imageHeight,jpgQuality:this.jpgQuality};this.image=await n.resizeLoadedImage(t,a),this.upload(this.image)}else this.$emit("error",new Error("Selected file must be a PNG, JPG, or GIF file."))},isAllowedFileType:function(e){return-1!==["image/png","image/jpg","image/jpeg","image/gif"].indexOf(e.type)},persist:function(e,t){console.info("Persist image => "+t)},upload:async function(e){var a=this;this.state="uploading",this.uploadPercent=0;var i,r,n={filename:(i=e.file.name,r=i.lastIndexOf("."),-1===r?i+Date.now():i.substring(0,r)+Date.now()+i.substring(r)),filesize:e.file.size,filetype:e.file.type,metadata:e.metadata};try{var o=this.baseUrl+this.signatureUrl,l=new d(o),u=await l.signUpload(n),p=this._uploaderForSignedUploadResult(u),h=t.imageToBlob(e.image,e.file.type),c=await p.upload(u,h,function(e){a.uploadPercent=e});if(c&&this.trackImageStatus){var f=c;f.fileInfo=n;var g=this.baseUrl+this.imageIndexUrl,m=new s(g,this.imageStatusCollection),v=await m.add(f);200!==v.status_code&&console.info("Error adding image status: ",v.status_text)}console.log("Image uploaded: ",c),this.$emit("input",c),this.image=null}catch(e){this._clearImage(),console.error("Error uploading image",e)}},_uploaderForSignedUploadResult:function(e){if("s3"===e.service)return new l;if("cloudStorage"===e.service)return new u;throw new Error("Unknown upload service: "+e.service)},_clearImage:function(){this.image=null,this.value=null,this.state="empty",this.$emit("input",null)}},computed:{previewSrc:function(){return this.value&&this.value.publicUrl?this.value.publicUrl:this.image&&this.image.image?this.image.image.src:null}},watch:{value:{immediate:!0,handler:function(e){e&&e.publicUrl?this.state="populated":this.state="empty"}}}};var h=function(e,t,a,i,r,n,o,s,d,l){"boolean"!=typeof o&&(d=s,s=o,o=!1);var u,p="function"==typeof a?a.options:a;if(e&&e.render&&(p.render=e.render,p.staticRenderFns=e.staticRenderFns,p._compiled=!0,r&&(p.functional=!0)),i&&(p._scopeId=i),n?(u=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,d(e)),e&&e._registeredComponents&&e._registeredComponents.add(n)},p._ssrRegister=u):t&&(u=o?function(){t.call(this,l(this.$root.$options.shadowRoot))}:function(e){t.call(this,s(e))}),u)if(p.functional){var h=p.render;p.render=function(e,t){return u.call(t),h(e,t)}}else{var c=p.beforeCreate;p.beforeCreate=c?[].concat(c,u):[u]}return a},c="undefined"!=typeof navigator&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());var f=document.head||document.getElementsByTagName("head")[0],g={};var m=h({render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{ref:"dropZone",staticClass:"ponyImage",class:e.dropZoneClass,style:{width:e.width+"px",height:e.height+"px"}},[a("div",{directives:[{name:"show",rawName:"v-show",value:"empty"===e.state,expression:"state === 'empty'"}],staticClass:"panel dropPanel",on:{dragenter:function(t){return t.preventDefault(),e._dragEnter(t)},dragleave:function(t){return t.preventDefault(),e._dragLeave(t)},dragover:function(t){return t.preventDefault(),e._dragOver(t)},drop:function(t){return t.preventDefault(),e._drop(t)},click:function(t){return e.$refs.fileInput.click()}}},[a("input",{ref:"fileInput",attrs:{type:"file",accept:"image/png, image/jpeg, image/jpg, image/gif",multiple:"false"},on:{change:e._selectedFile}}),e._v(" "),e.acceptDrop?a("p",[e._v("Drop Image")]):a("p",[e._v("Select Image")])]),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:"empty"!==e.state,expression:"state !== 'empty'"}]},[a("div",{ref:"preview",staticClass:"panel previewPanel"},[a("img",{attrs:{src:e.previewSrc}})]),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:"uploading"===e.state,expression:"state === 'uploading'"}],staticClass:"panel uploadOverlay"},[a("p",[e._v("Uploading")]),e._v(" "),a("div",{staticClass:"progress"},[a("div",{staticClass:"progressPercent",style:{width:e.uploadPercent+"%"}})])]),e._v(" "),a("a",{directives:[{name:"show",rawName:"v-show",value:"populated"===e.state,expression:"state === 'populated'"}],staticClass:"clearButton",on:{click:e._clearImage}},[a("svg",{attrs:{width:"200px",height:"200px",viewBox:"0 0 200 200",version:"1.1",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"}},[a("g",{attrs:{id:"Page-1",stroke:"none","stroke-width":"1",fill:"none","fill-rule":"evenodd"}},[a("g",{attrs:{id:"Artboard",fill:"#D40000","fill-rule":"nonzero"}},[a("path",{attrs:{d:"M100,200 C44.771525,200 0,155.228475 0,100 C0,44.771525 44.771525,0 100,0 C155.228475,0 200,44.771525 200,100 C200,155.228475 155.228475,200 100,200 Z M100,78.7867966 L64.6446609,43.4314575 C58.7867966,37.5735931 49.2893219,37.5735931 43.4314575,43.4314575 C37.5735931,49.2893219 37.5735931,58.7867966 43.4314575,64.6446609 L78.7867966,100 L43.4314575,135.355339 C37.5735931,141.213203 37.5735931,150.710678 43.4314575,156.568542 C49.2893219,162.426407 58.7867966,162.426407 64.6446609,156.568542 L100,121.213203 L135.355339,156.568542 C141.213203,162.426407 150.710678,162.426407 156.568542,156.568542 C162.426407,150.710678 162.426407,141.213203 156.568542,135.355339 L121.213203,100 L156.568542,64.6446609 C162.426407,58.7867966 162.426407,49.2893219 156.568542,43.4314575 C150.710678,37.5735931 141.213203,37.5735931 135.355339,43.4314575 L100,78.7867966 Z",id:"cancel-button"}})])])])])])])},staticRenderFns:[]},function(e){e&&e("data-v-4a0fb92c_0",{source:".ponyImage[data-v-4a0fb92c]{display:inline-block;position:relative;overflow:hidden;border:1px solid silver}.ponyImage .dropPanel[data-v-4a0fb92c]{cursor:pointer;color:#4a90e2}.ponyImage .dropPanel input[type=file][data-v-4a0fb92c]{display:none}.ponyImage .dropPanel p[data-v-4a0fb92c]{margin:0}.ponyImage .dropPanel[data-v-4a0fb92c]  img{position:absolute;top:50%;left:50%;width:100%;transform:translateX(-50%) translateY(-50%)}.ponyImage .dropPanel[data-v-4a0fb92c]:hover{text-decoration:underline}.ponyImage .dropPanel *[data-v-4a0fb92c]{pointer-events:none}.ponyImage .uploadIcon[data-v-4a0fb92c]{max-width:50px;height:auto;margin:0 auto}.ponyImage .uploadIcon[data-v-4a0fb92c]  path{fill:#4a90e2}.ponyImage .uploadIconRed[data-v-4a0fb92c]  path{fill:red}.ponyImage .uploadIconWhite[data-v-4a0fb92c]  path{fill:#fff}.ponyImage .details[data-v-4a0fb92c]{font-size:12px;margin:0}.ponyImage .panel[data-v-4a0fb92c]{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;flex-direction:column;text-align:center}.ponyImage .previewPanel[data-v-4a0fb92c]  img{width:100%;height:100%;height:auto}.ponyImage .clearButton[data-v-4a0fb92c]{position:absolute;width:30px;height:30px;left:10px;bottom:10px;transition:transform .3s}.ponyImage .clearButton svg[data-v-4a0fb92c]{width:100%;height:auto}.ponyImage .clearButton[data-v-4a0fb92c]:hover{transform:scale3d(1.1,1.1,1)}.ponyImage .uploadOverlay[data-v-4a0fb92c]{background-color:rgba(0,0,0,.4);color:#fff}.ponyImage .uploadOverlay p[data-v-4a0fb92c]{margin:0 auto}.ponyImage .uploadOverlay .progress[data-v-4a0fb92c]{position:absolute;left:10%;right:10%;bottom:5%;height:4px;background-color:rgba(0,0,0,.8);margin:0 auto;padding:0}.ponyImage .uploadOverlay .progress .progressPercent[data-v-4a0fb92c]{width:0;height:100%;margin:0;padding:0;background-color:#fff}",map:void 0,media:void 0})},p,"data-v-4a0fb92c",!1,void 0,function(e){return function(e,t){return function(e,t){var a=c?t.media||"default":e,i=g[a]||(g[a]={ids:new Set,styles:[]});if(!i.ids.has(e)){i.ids.add(e);var r=t.source;if(t.map&&(r+="\n/*# sourceURL="+t.map.sources[0]+" */",r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(t.map))))+" */"),i.element||(i.element=document.createElement("style"),i.element.type="text/css",t.media&&i.element.setAttribute("media",t.media),f.appendChild(i.element)),"styleSheet"in i.element)i.styles.push(r),i.element.styleSheet.cssText=i.styles.filter(Boolean).join("\n");else{var n=i.ids.size-1,o=document.createTextNode(r),s=i.element.childNodes;s[n]&&i.element.removeChild(s[n]),s.length?i.element.insertBefore(o,s[n]):i.element.appendChild(o)}}}(e,t)}},void 0);function v(e){v.installed||(v.installed=!0,e.component("PonyUploader",m))}var w={install:v},y=null;"undefined"!=typeof window?y=window.Vue:"undefined"!=typeof global&&(y=global.Vue),y&&y.use(w),m.install=v,e.default=m,Object.defineProperty(e,"__esModule",{value:!0})});