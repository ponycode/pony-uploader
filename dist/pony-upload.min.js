/*! pony-uploader v0.0.1, 2015-03-25 */
var ponyImageResize=function(a,b,c){function d(a,c,d,f){var g=new FileReader,h=b.createElement("canvas"),i=new Image,j="image/png";a.type.match("image.*")?g.readAsDataURL(a):f(new Error("The input file is not an image."),!1),g.onload=function(){i.src=this.result},g.onabort=function(){f(new Error("The file read was aborted."),!1)},g.onerror=function(){f(new Error("An error occured while reading the file."),!1)},i.onload=function(){var g=this;if(0==g.width||0==g.height)f(new Error("The image is empty."),!1);else{var k=0,l=0;if(this.width>c||g.height>d){var m=g.width/c,n=g.height/d;n>m?(k=g.width/n,l=d):(k=c,l=g.height/m)}else k=g.width,l=g.height;var o=h.getContext("2d");h.id="hiddenCanvas",h.width=k,h.height=l,h.style.visibility="hidden",b.body.appendChild(h),o.clearRect(0,0,k,l),o.drawImage(i,0,0,g.width,g.height,0,0,k,l),e(h.toDataURL(j),j,function(c,d){if(b.body.removeChild(h),c)return void f(c,!1);var e={blob:d,width:k,height:l,originalWidth:g.width,originalHeight:g.height,dataType:j,originalDataType:a.type};f(!1,e)})}},i.onabort=function(){f(new Error("Image load was aborted."),result)},i.onerror=function(){f(new Error("An error occured while loading image."),result)}}function e(a,b,d){if("string"!=typeof a)throw new Error("Invalid argument: dataURI must be a string");(typeof atob===c||typeof Uint8Array===c||typeof Blob===c)&&d(new Error("Browser will not support image resizing."),!1);for(var e=atob(a.split(",")[1]),f=[],g=0;g<e.length;g++)f.push(e.charCodeAt(g));d(!1,new Blob([new Uint8Array(f)],{type:b}))}return{resizeFile:d}}(window,document),ponyUploader=function(){function a(a,b){var c={url:a};d(c,function(a,c){return a?void b(a,!1):void b(!1,c)})}function b(a,b,c){var e={url:a+="?filename="+b.filename+"&filesize="+b.filesize+"&filetype="+b.filetype+"&width="+b.width+"&height="+b.height};d(e,function(a,b){return a?void c(a,!1):void(b&&b.uploadUrl&&b.completeUrl?c(!1,b):c(new Error("Error signing upload: no data returned"),!1))})}function c(a,b,c,d){var f=e("PUT",a);return f?(f.onload=function(){200===f.status?d(!1,!0):d(new Error("A file upload error occurred: "+f.status),!1)},f.onerror=function(){d(new Error("A file upload error occurred: "+f.status),!1)},f.upload.onprogress=function(a){var b=Math.round(a.loaded/a.total*100);c&&c(b)},f.setRequestHeader("Content-Type",b.filetype),f.setRequestHeader("x-amz-acl","public-read"),f.send(b.blob)):(console.error("CORS is not support."),void d(new Error("File uploads are not supported by this browser.")))}function d(a,b){var c=e("GET",a.url);return c?(c.onload=function(){if(200===c.status){var a=!1;try{a=JSON.parse(this.responseText)}catch(d){console.error("Error parsing json response: ",this.responseText)}b(!1,a)}else b(new Error("An HTTP error occurred: "+c.status))},c.onerror=function(){b(new Error("An error occurred ["+c.status+"]: "+c.responseText))},c.upload.onprogress=function(b){var c=Math.round(b.loaded/b.total*100);a.progressCallback&&a.progressCallback(c)},c.send()):(console.error("XHR is not support."),void b(new Error("File uploads are not supported by this browswer.")))}function e(a,b){var c;return c=new XMLHttpRequest,null!=c.withCredentials?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c}return{getSignedUpload:b,uploadToS3:c,completeUpload:a}}(window,document);!function(a){var b="dropZoneDefault dropZoneDrop dropZoneUploading dropZoneError dropZoneComplete";a.fn.ponyUpload=function(){a(this).each(function(){function c(a){g.attr("aria-valuenow",a).css({width:a+"%"})}function d(d,f){h=d,e.removeClass(b),"initial"===h?(c(0),e.addClass("dropZoneDefault")):"allowDrop"===h?e.addClass("dropZoneDrop"):"uploading"===h?e.addClass("dropZoneUploading"):"error"===h?(f&&a(".errorMessage").text(f.message||f),e.addClass("dropZoneError")):"complete"===h&&e.addClass("dropZoneComplete")}var e=a(this),f=e.attr("data-signUrl"),g=e.find(".progress-bar"),h="initial";e.on("dragenter",function(a){a.stopPropagation(),a.preventDefault(),"initial"===h&&d("allowDrop")}),e.on("dragleave",function(a){a.stopPropagation(),a.preventDefault(),"allowDrop"===h&&d("initial")}),e.on("dragover",function(a){a.stopPropagation(),a.preventDefault()}),e.on("drop",function(a){if(a.stopPropagation(),a.preventDefault(),a&&a.originalEvent&&a.originalEvent.dataTransfer&&a.originalEvent.dataTransfer.files&&"allowDrop"===h){d("uploading");var b=a.originalEvent.dataTransfer.files,e=b[0];ponyImageResize.resizeFile(e,1024,1024,function(a,b){var g={filename:e.name,filetype:e.type,filesize:b.blob.size,originalFilesize:e.size,width:b.width,height:b.height,blob:b.blob};ponyUploader.getSignedUpload(f,g,function(a,b){return a?void d("error",a):(console.log("GOT AN S3 SIGNATURE: ",b),void ponyUploader.uploadToS3(b.uploadUrl,g,c,function(a,c){return a?void d("error",a):(console.log("DONE WITH UPLOAD: ",c),void ponyUploader.completeUpload(b.completeUrl,function(a,b){return a?void d("error",a):(console.log("UPLOAD COMPLETED",b),d("complete",a),void setTimeout(function(){d("initial",a)},3e3))}))}))})})}})})}}(jQuery,window,document);