/*! pony-uploader v0.0.4, 2015-03-26 */
var ponyEXIF=function(){function a(a,c){var d=new DataView(a);if(255!=d.getUint8(0)||216!=d.getUint8(1))return void c(new Error("Not a valid JPEG"),!1);for(var e,f=2,g=a.byteLength;g>f;){if(255!=d.getUint8(f))return void c(new Error("Not a valid JPEG"),!1);if(e=d.getUint8(f+1),225==e){var h=b(d,f+4,d.getUint16(f+2)-2);return void c(!1,h)}f+=2+d.getUint16(f+2)}c(new Error("Not a valid JPEG"),!1)}function b(a,b){if("Exif"!=e(a,b,4))return!1;var d,g=b+6;if(18761==a.getUint16(g))d=!1;else{if(19789!=a.getUint16(g))return!1;d=!0}if(42!=a.getUint16(g+2,!d))return!1;var h=a.getUint32(g+4,!d);return 8>h?!1:c(a,g,g+h,f,d)}function c(a,b,c,e,f){for(var g,h,i=a.getUint16(c,!f),j={},k=0;i>k;k++)g=c+12*k+2,h=e[a.getUint16(g,!f)],h&&(j[h]=d(a,g,b,c,f));return j}function d(a,b,c,d,f){var g,h=a.getUint16(b+2,!f),i=a.getUint32(b+4,!f),j=a.getUint32(b+8,!f)+c;switch(h){case 2:return g=i>4?j:b+8,e(a,g,i-1);case 3:if(1==i)return a.getUint16(b+8,!f);g=i>2?j:b+8;for(var k=[],l=0;i>l;l++)k[l]=a.getUint16(g+2*l,!f);return k}}function e(a,b,c){for(var d="",e=b;b+c>e;e++)d+=String.fromCharCode(a.getUint8(e));return d}var f={274:"Orientation",306:"DateTime",271:"Make",272:"Model"};return{getExifFromJPEGArrayBuffer:a}}(),ponyImageResize=function(a,b,c){function d(a,d,e,h){function i(a,c,d){g(a,c,function(c,e){var f=j(a,e),g=k(f.width,f.height,e.Orientation),h=g.getContext("2d");h.drawImage(m,0,0,f.width,f.height);var i=g.toDataURL("image/jpeg",.8);b.body.removeChild(g),d(!1,{dataUrl:i,width:g.width,height:g.height})})}function j(a){var b=a.width,c=a.height;if(a.width>d||a.height>e){var f=a.width/d,g=a.height/e;g>f?(b=a.width/g,c=e):(b=d,c=a.height/f)}return{width:Math.floor(b),height:Math.floor(c)}}function k(a,c,d){(!d||d>8)&&(d=1);var e=b.createElement("canvas");e.id="hiddenCanvas",e.width=a,e.height=c,d>4&&(e.width=c,e.height=a);var f=e.getContext("2d");switch(d){case 2:f.translate(a,0),f.scale(-1,1);break;case 3:f.translate(a,c),f.rotate(Math.PI);break;case 4:f.translate(0,c),f.scale(1,-1);break;case 5:f.rotate(.5*Math.PI),f.scale(1,-1);break;case 6:f.rotate(.5*Math.PI),f.translate(0,-c);break;case 7:f.rotate(.5*Math.PI),f.translate(a,-c),f.scale(-1,1);break;case 8:f.rotate(-.5*Math.PI),f.translate(-a,0)}return e.style.visibility="hidden",b.body.appendChild(e),e}(typeof atob===c||typeof Uint8Array===c||typeof Blob===c||typeof ArrayBuffer===c)&&h(new Error("Browser will not support image resizing."),!1);var l=new FileReader,m=new Image;a.type.match("image.*")?l.readAsDataURL(a):h(new Error("The input file is not an image."),!1),l.onload=function(){m.src=this.result},l.onabort=function(){h(new Error("The file read was aborted."),!1)},l.onerror=function(){h(new Error("An error occured while reading the file."),!1)},m.onload=function(){var b=this;return 0==b.width||0==b.height?void h(new Error("The image is empty."),!1):void i(b,a.type,function(c,d){return c||!d?h(c||"No data url returned",!1):void f(d.dataUrl,"image/jpeg",function(c,e){return c?h(c,!1):void h(!1,{blob:e,width:d.width,height:d.height,originalWidth:b.width,originalHeight:b.height,originalDataType:a.type})})})},m.onabort=function(){h(new Error("Image load was aborted."),result)},m.onerror=function(){h(new Error("An error occured while loading image."),result)}}function e(a){if("string"!=typeof a)throw new Error("Invalid argument: dataURI must be a string");for(var b=atob(a.split(",")[1]),c=b.length,d=new ArrayBuffer(c),e=new Uint8Array(d),f=0;c>f;f++)e[f]=b.charCodeAt(f);return d}function f(a,b,c){if("string"!=typeof a)throw new Error("Invalid argument: dataURI must be a string");for(var d=atob(a.split(",")[1]),e=[],f=0;f<d.length;f++)e.push(d.charCodeAt(f));c(!1,new Blob([new Uint8Array(e)],{type:b}))}function g(a,b,c){var d={Orientation:1,DateTime:!1,Make:!1,Model:!1};if("image/jpg"!==b&&"image/jpeg"!==b)return c(!1,d);var f=e(a.src);ponyEXIF.getExifFromJPEGArrayBuffer(f,function(a,b){b||(b=d),a&&console.error("Error getting exif data: ",a),c(!1,b)})}return{resizeFile:d}}(window,document),ponyUploader=function(){function a(a,b){var c={url:a};d(c,function(a,c){return a?void b(a,!1):void b(!1,c)})}function b(a,b,c){var e={url:a+="?filename="+b.filename+"&filesize="+b.filesize+"&filetype="+b.filetype+"&width="+b.width+"&height="+b.height};d(e,function(a,b){return a?void c(a,!1):void(b&&b.uploadUrl&&b.completeUrl?c(!1,b):c(new Error("Error signing upload: no data returned"),!1))})}function c(a,b,c,d){var f=e("PUT",a);return f?(f.onload=function(){200===f.status?d(!1,!0):d(new Error("A file upload error occurred: "+f.status),!1)},f.onerror=function(){d(new Error("A file upload error occurred: "+f.status),!1)},f.upload.onprogress=function(a){var b=Math.round(a.loaded/a.total*100);c&&c(b)},f.setRequestHeader("Content-Type",b.filetype),f.setRequestHeader("x-amz-acl","public-read"),f.send(b.blob)):(console.error("CORS is not support."),void d(new Error("File uploads are not supported by this browser.")))}function d(a,b){var c=e("GET",a.url);return c?(c.onload=function(){if(200===c.status){var a=!1;try{a=JSON.parse(this.responseText)}catch(d){console.error("Error parsing json response: ",this.responseText)}b(!1,a)}else b(new Error("An HTTP error occurred: "+c.status))},c.onerror=function(){b(new Error("An error occurred ["+c.status+"]: "+c.responseText))},c.upload.onprogress=function(b){var c=Math.round(b.loaded/b.total*100);a.progressCallback&&a.progressCallback(c)},c.send()):(console.error("XHR is not support."),void b(new Error("File uploads are not supported by this browswer.")))}function e(a,b){var c;return c=new XMLHttpRequest,null!=c.withCredentials?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c}return{getSignedUpload:b,uploadToS3:c,completeUpload:a}}(window,document);!function(a){var b="dropZoneDefault dropZoneDrop dropZoneUploading dropZoneError dropZoneComplete",c={allowedFileTypes:["image/png","image/jpg","image/jpeg","image/gif"],imageUploadComplete:function(a){console.log("ALL DONE",a)}};a.fn.ponyUpload=function(d){function e(a){var b=f.allowedFileTypes.indexOf(a.type);return-1!==b}var f=a.extend(c,d);a(this).each(function(){function c(a){i.attr("aria-valuenow",a).css({width:a+"%"})}function d(e,f){j=e,g.removeClass(b),"initial"===j?(c(0),g.addClass("dropZoneDefault")):"allowDrop"===j?g.addClass("dropZoneDrop"):"uploading"===j?g.addClass("dropZoneUploading"):"error"===j?(f&&a(".errorMessage").text(f.message||f),g.addClass("dropZoneError"),setTimeout(function(){d("initial")},3e3)):"complete"===j&&(g.addClass("dropZoneComplete"),setTimeout(function(){d("initial")},3e3))}var g=a(this),h=g.attr("data-signUrl"),i=g.find(".progress-bar"),j="initial";g.on("dragenter",function(a){a.stopPropagation(),a.preventDefault(),"initial"===j&&d("allowDrop")}),g.on("dragleave",function(a){a.stopPropagation(),a.preventDefault(),"allowDrop"===j&&d("initial")}),g.on("dragover",function(a){a.stopPropagation(),a.preventDefault()}),g.on("drop",function(a){if(a.stopPropagation(),a.preventDefault(),a&&a.originalEvent&&a.originalEvent.dataTransfer&&a.originalEvent.dataTransfer.files&&"allowDrop"===j){d("uploading");var b=a.originalEvent.dataTransfer.files,g=b[0];return e(g)?void ponyImageResize.resizeFile(g,1024,1024,function(a,b){var e={filename:g.name,filetype:g.type,filesize:b.blob.size,originalFilesize:g.size,width:b.width,height:b.height,blob:b.blob};ponyUploader.getSignedUpload(h,e,function(a,b){return a?void d("error",a):(console.log("GOT AN S3 SIGNATURE: ",b),void ponyUploader.uploadToS3(b.uploadUrl,e,c,function(a,c){return a?void d("error",a):(console.log("DONE WITH UPLOAD: ",c),void ponyUploader.completeUpload(b.completeUrl,function(a,b){return a?void d("error",a):(console.log("UPLOAD COMPLETED",b),f.imageUploadComplete&&f.imageUploadComplete(b),void d("complete",a))}))}))})}):void d("error",new Error("Invalid file type: "+g.type))}})})}}(jQuery,window,document);